### train

> 我们会跑很多对比试验，所以需要做版本隔离
> 你需要魔改 train.py 使得能从命令行额外传入 `--exp <name> --source [rgb|inf|mix]` 来运行下列实验，并使得结果分别输出在 weights/\<name\>/*.pth

train the following configuration:

- [$\circ$] Seg-rgb: SegNet with rgb input (in_ch=3)
- [$\circ$] Seg-inf: SegNet with inf input (in_ch=1)
- [$\circ$] Seg-mix: SegNet with rgb+inf input (in_ch=4)
- [$\circ$] MF: MFNet with rgb+inf input (in_ch=4)

### attack

lauch attacks on `test` dataset split, gather metrcis to fill following table:

> Q: Seg-mix/MF 搭配 limit=rgb/inf 是什么意思，如何实现?
> A: 从数据意义上，这两个模型都需要输入两个成分，通常的PGD攻击会在整个输入(也就是两个成份上)同时添加扰动，而我们想要测试只在一个成分上添加扰动的攻击效果 ;) 
> 实现方式：魔改 attack.py 在取得 loss 后，给 loss 加一个 mask 以掩蔽另一个暂时不考虑的成分所产生的损失值，给 grad 也加同样的 mask 保证产生新的对抗样本时没有在该成分上引入噪声

参考实现 (你应该写得更灵活，而不是if-else写死各种情况)：

```python
# [B, C=4, H, W], C 方向 0~2 是 rgb, 3 是 inf
# 考虑现在 limit=rgb 而不能修改 inf
X = randn([1, 4, 224, 224])
# 产生mask
M = zeros_like(X)
M[:, :2, :, :] = 1   # allow rgb part
# 初始噪声
AX = X + randu_like(X, -eps, eps) * M
# 迭代噪声
logits = model(X)
loss = loss_fn(logits, Y) * M
g = grad(loss, X, loss) * M
AX_new = AX + g.sign() * step_size
......
```


### eval

> 同理，你需要魔改 test.py 使得能从命令行额外传入 `--exp <name> --split [train|val|test]` 来进行下面的实验

run infer on all dataset splits, gather metrcis to fill following table(Acc/mIoU): 

⚪ FGSM

> **e** for eps; **e** need /255

| name | limit | eps=4 | eps=8 | eps=12 | eps=16 |
| :-: | :-: | :-: | :-: | :-: | :-: |
| Seg-rgb |   -    | 18.30%/23.97% | 12.11%/23.02% | 8.24%/22.80% | 5.07%/23.31% |
| Seg-inf |   -    | 11.06%/23.07% | 4.36%/18.99% | 1.42%/19.56% | 0.22%/21.01% |
| Seg-mix |   -    | 22.73%/16.89% | 19.41%/12.00% | 17.47%/10.56% | 15.83%/9.81% |
| Seg-mix |  rgb   | 24.99%/20.08% | 21.80%/14.27% | 20.01%/11.91% | 18.64%/10.75% |
| Seg-mix |  inf   | 32.43%/34.67% | 27.00%/29.19% | 24.25%/22.66% | 22.25%/20.12% |
| MF      |  -     | 21.84%/22.43% | 16.31%/12.59% | 13.46%/9.82% | 11.72%/ 9.62% |
| MF      |  rgb   | 28.01%/25.91% | 23.85%/18.06% | 22.16%/16.06% | 20.92%/15.01% |
| MF      |  inf   | 47.78%/51.14% | 44.24%/49.72% | 39.85%/42.84% | 37.61%/34.62% |

⚪ PGD

> **e** for eps, **a** for alpha, **s** for steps; **e** and **a** need /255, and Acc here is overall_acc, not acc.mean(), Acc/mIoU

| name | limit | e=4,a=1,s=10 | e=8,a=1,s=10 | e=8,a=1,s=20 | e=16,a=1,s=20 |
| :-: | :-: | :-: | :-: | :-: | :-: |
| Seg-rgb |   -    | 10.28%/8.90% | 5.76%/6.70% | 11.79%/4.27% | 6.45%/2.81% | 
| Seg-inf |   -    | 9.17%/4.89% | 6.28%/3.40% | 11.00%/2.89% | 13.40%/2.94% | 
| Seg-mix |   -    | 15.75%/8.64% | 14.09%/7.52% | 15.96%/5.31% | 11.88%/4.74% | 
| Seg-mix |  rgb   | 16.72%/11.43% | 14.32%/9.30% | 15.53%/6.04% | 10.93%/4.97% | 
| Seg-mix |  inf   | 23.30%/21.93% | 18.33%/17.93% | 15.09%/13.53% | 10.97%/8.61% | 
| MF      |  -     | 12.93%/11.87% | 11.27%/6.70% | 12.64%/5.32% | 9.25%/3.40% | 
| MF      |  rgb   | 15.30%/16.04% | 12.38%/8.19% | 12.19%/6.25% | 7.34%/4.05% | 
| MF      |  inf   | 26.09%/35.67% | 20.45%/19.87% | 18.15%/16.87% | 10.07%/9.32% | 

多模态模型测试 ( 无数据融合 )

| name | Train | Val | Test |
| :-: | :-: | :-: | :-: |
| Seg-rgb | 79.83%/58.84% | 52.85%/50.07% | 56.19%/49.67% |
| Seg-inf | 78.72%/51.24% | 36.94%/36.07% | 49.33%/38.22% |
| Seg-mix | 84.51%/62.37% | 54.62%/50.38% | 56.41%/50.61% |
| MF      | 84.45%/82.15% | 53.83%/62.54% | 60.79%/57.70% |
| DeepLabV3-rgb | 98.09%/86.62% | 76.33%/69.82% | 80.18%/65.56% |
| DeepLabV3-mix | 97.76%/86.45% | 68.44%/63.45% | 74.17%/60.41% |

将原数据集中图片经过两种融合模型融合后训练并测试得出结果(Acc / mIoU)

| Fuse + model | Train | Val | Test |
| :-: | :-: | :-: | :-: |
| MMIF-CDDFuse + SegNet | 85.75%/60.42% | 37.09%/37.66% | 43.73%/39.99% |
| Dif-Fusion + SegNet | 83.93%/52.59% | 36.79%/34.63% | 42.13%/35.79% |
| MMIF-CDDFuse + DeepLabV3 | 79.08%/86.32% | 59.85%/54.67% | 70.46%/57.73% |
| Dif-Fusion + DeepLabV3 | 97.77%/86.31% | 64.18%/57.26% | 68.80%/57.19% |

----

在PGD攻击, 参数为 eps = 8/255, alpha = 1/255, steps = 16. 下表中不同channel代表攻击的通道, 结果为acc/mIoU

| model | channel[0] | channel[1] | channel[2] | channel[ir] |
| :-: | :-: | :-: | :-: | :-: |
| SegNet-rgb | 5.94%/11.58% | 5.51%/8.82% | 5.90%/11.68% | - |
| SegNet-mix | 17.23%/17.61% | 15.03%/13.03% | 17.89%/16.60% | 16.16%/15.34% |
| MFNet | 17.85%/17.98% | 14.21%/11.26% | 16.01%/15.63% | 18.91%/18.14% |
| DeepLabV3-rgb | 33.34%/22.72% | 29.66%/22.41% | 33.73%/24.48% | - |
| DeepLabV3-mix | 24.67%/27.48% | 24.01%/23.05% | 23.33%/25.93% | 23.62%/25.21% |


| model | channel[0+1] | channel[0+2] | channel[1+2] | channel[0+ir] | channel[1+ir] | channel[2+ir] |
| :-: | :-: | :-: | :-: | :-: | :-: | :-: |
| SegNet-rgb | 6.49%/5.86% | 6.49%/7.08% | 6.82%/6.00% | - | - | - |
| SegNet-mix | 14.72%/8.82% | 14.65%/10.69% | 14.27%/8.38% | 13.88%/9.88% | 14.03%/7.68% | 14.15%/9.23% |
| MFNet | 12.49%/7.87% | 12.88%/10.29% | 12.37%/7.99% | 11.69%/9.60% | 11.26%/6.96% | 11.35%/9.05% |
| DeepLabV3-rgb | 28.12%/20.60% | 27.73%/21.54% | 27.37%/21.30% | - | - | - |
| DeepLabV3-mix | 19.30%/19.30% | 19.65%/21.58% | 19.87%/20.64% | 19.95%/21.06% | 19.30%/16.86% | 19.33%/21.40% |


| model | channel[rgb] | channel[0+1+ir] | channel[0+2+ir] | channel[1+2+ir] | channel[rgb+ir] |
| :-: | :-: | :-: | :-: | :-: | :-: |
| SegNet-rgb | 8.35%/4.57% | - | - | - | - | 
| SegNet-mix | 15.01%/6.80% | 14.26%/6.59% | 14.74%/7.39% | 14.24%/6.22% | 15.36%/5.90% |
| MFNet | 12.01%/6.77% | 11.55%/6.01% | 11.22%/6.93% | 11.65%/6.02% | 11.88%/5.43% |
| DeepLabV3-rgb | 25.46%/18.84% | - | - | - | - |
| DeepLabV3-mix | 17.90%/14.72% | 18.59%/14.67% | 19.65%/20.04% | 19.65%/19.79% | 17.52%/15.03% |


在MIFGSM攻击, 参数为eps = 8/255, alpha = 2/255, steps = 10, decay = 1.0. 下表中不同channel代表攻击的通道, 结果为acc/mIoU

| model | channel[0] | channel[1] | channel[2] | channel[ir] |
| :-: | :-: | :-: | :-: | :-: |
| SegNet-rgb | 14.71%/17.43% | 10.87%/10.99% | 14.36%/17.09% | - |
| SegNet-mix | 27.36%/28.82% | 18.61%/12.09% | 26.04%/23.06% | 21.69%/16.73% |
| MFNet | 33.73%/39.81% | 20.46%/11.27% | 28.06%/24.52% | 36.04%/28.81% |
| DeepLabV3-rgb | 49.29%/33.97% | 41.03%/23.34% | 56.43%/43.00% | - |
| DeepLabV3-mix | 39.56%/33.01% | 38.35%/31.88% | 38.66%/32.10% | 35.84%/29.60% |


| model | channel[0+1] | channel[0+2] | channel[1+2] | channel[0+ir] | channel[1+ir] | channel[2+ir] |
| :-: | :-: | :-: | :-: | :-: | :-: | :-: |
| SegNet-rgb | 9.37%/6.79% | 9.51%/8.10% | 9.40%/6.64% | - | - | - |
| SegNet-mix | 13.52%/7.04% | 16.39%/10.80% | 13.42%/6.67% | 15.12%/9.18% | 12.54%/5.86% | 14.40%/7.88% |
| MFNet | 15.72%/7.42% | 17.87%/12.00% | 15.22%/6.79% | 14.99%/15.61% | 11.18%/5.11% | 12.71%/8.21% |
| DeepLabV3-rgb | 32.41%/13.83% | 35.80%/17.82% | 33.41%/14.80% | - | - | - |
| DeepLabV3-mix | 25.22%/18.45% | 25.29%/18.57% | 24.74%/17.69% | 24.24%/17.12% | 23.88%/16.31% | 23.80%/16.48% |


| model | channel[rgb] | channel[0+1+ir] | channel[0+2+ir] | channel[1+2+ir] | channel[rgb+ir] |
| :-: | :-: | :-: | :-: | :-: | :-: |
| SegNet-rgb | 9.85%/5.45% | - | - | - | - |
| SegNet-mix | 11.45%/4.70% | 11.15%/4.44% | 11.82%/5.27% | 11.14%/4.30% | 10.90%/3.90% |
| MFNet | 14.01%/5.57% | 10.64%/4.43% | 10.50%/5.29% | 10.74%/4.33% | 10.86%/4.10% |
| DeepLabV3-rgb | 31.28%/12.45% | - | - | - | - |
| DeepLabV3-mix | 21.34%/12.40% | 21.18%/12.10% | 21.17%/12.02% | 21.10%/11.97% | 20.65%/11.19% |

----
by Armit
2024/3/12
